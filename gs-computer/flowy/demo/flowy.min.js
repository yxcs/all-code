var flowy=function(e,t,i,l,r,d){function f(e){l(e)}t||(t=function(){}),i||(i=function(){}),l||(l=function(){}),r||(r=20),d||(d=80),$(document).ready(function(){var l,a,o,n,s=[],p=[],c=e,h=!1,v=r,u=d,w=0,g=0,x=!1,b=!1;function k(){w=s.map(e=>e.x);var e=s.map(e=>e.width),t=w.map(function(t,i){return t-e[i]/2});if((w=Math.min.apply(Math,t))<c.offset().left){b=!0;for(var i=s.map(e=>e.id),l=0;l<s.length;l++)if($(".blockid[value="+s.filter(e=>e.id==i[l])[0].id+"]").parent().css("left",s.filter(e=>e.id==i[l])[0].x-s.filter(e=>e.id==i[l])[0].width/2-w+20),-1!=s.filter(e=>e.id==i[l])[0].parent){var r=s.filter(e=>e.id==i[l])[0];r.x-s.filter(e=>e.id==s.filter(e=>e.id==i[l])[0].parent)[0].x<0?$(".arrowid[value="+i[l]+"]").parent().css("left",r.x-w+20-5+"px"):$(".arrowid[value="+i[l]+"]").parent().css("left",s.filter(e=>e.id==s.filter(e=>e.id==i[l])[0].parent)[0].x-20-w+20+"px")}for(l=0;l<s.length;l++)s[l].x=$(".blockid[value="+s[l].id+"]").parent().offset().left+c.offset().left-$(".blockid[value="+s[l].id+"]").parent().innerWidth()/2-40;g=w}}function m(){for(var e=s.map(e=>e.parent),t=0;t<e.length;t++){-1==e[t]&&t++;for(var i=0,l=0,r=0;r<s.filter(i=>i.parent==e[t]).length;r++){var d=s.filter(i=>i.parent==e[t])[r];0==s.filter(e=>e.parent==d.id).length&&(d.childwidth=0),d.childwidth>d.width?r==s.filter(i=>i.parent==e[t]).length-1?i+=d.childwidth:i+=d.childwidth+v:r==s.filter(i=>i.parent==e[t]).length-1?i+=d.width:i+=d.width+v}-1!=e[t]&&(s.filter(i=>i.id==e[t])[0].childwidth=i);for(r=0;r<s.filter(i=>i.parent==e[t]).length;r++){d=s.filter(i=>i.parent==e[t])[r];$(".blockid[value="+d.id+"]").parent().css("top",s.filter(i=>i.id==e[t]).y+u+"px"),s.filter(i=>i.id==e[t]).y=s.filter(i=>i.id==e[t]).y+u,d.childwidth>d.width?($(".blockid[value="+d.id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2-d.width/2-c.offset().left+"px"),d.x=s.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2,l+=d.childwidth+v):($(".blockid[value="+d.id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-i/2+l-c.offset().left+"px"),d.x=s.filter(i=>i.id==e[t])[0].x-i/2+l+d.width/2,l+=d.width+v);var f=s.filter(e=>e.id==d.id)[0],a=f.x-s.filter(e=>e.id==d.parent)[0].x+20,o=f.y-f.height/2-(s.filter(e=>e.id==d.parent)[0].y+s.filter(e=>e.id==d.parent)[0].height/2);$(".arrowid[value="+d.id+"]").parent().css("top",s.filter(e=>e.id==d.parent)[0].y+s.filter(e=>e.id==d.parent)[0].height/2-c.offset().top+"px"),a<0?($(".arrowid[value="+d.id+"]").parent().css("left",f.x-5-c.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(s.filter(e=>e.id==d.parent)[0].x-f.x+5)+" 0L"+(s.filter(e=>e.id==d.parent)[0].x-f.x+5)+" "+u/2+"L5 "+u/2+"L5 "+o+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(o-5)+"H10L5 "+o+"L0 "+(o-5)+'Z" fill="#C5CCD0"/></svg>')):($(".arrowid[value="+d.id+"]").parent().css("left",s.filter(e=>e.id==d.parent)[0].x-20-c.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+u/2+"L"+a+" "+u/2+"L"+a+" "+o+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(a-5)+" "+(o-5)+"H"+(a+5)+"L"+a+" "+o+"L"+(a-5)+" "+(o-5)+'Z" fill="#C5CCD0"/></svg>'))}}}c.append("<div class='indicator invisible'></div>"),flowy.output=function(){var e=[];if(s.length>0){for(var t=0;t<s.length;t++)e.push({id:s[t].id,parent:s[t].parent,data:[]}),$(".blockid[value="+s[t].id+"]").parent().children("input").each(function(){var i=$(this).attr("name"),l=$(this).val();e[t].data.push({name:i,value:l})});return e}},flowy.deleteBlocks=function(){s=[],c.html("<div class='indicator invisible'></div>")},$(document).on("mousedown",".create-flowy",function(e){var i;1===e.which&&(n=$(this),0==s.length?($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+s.length+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+s.length+"]").parent()):($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+(Math.max.apply(Math,s.map(e=>e.id))+1)+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+(parseInt(Math.max.apply(Math,s.map(e=>e.id)))+1)+"]").parent()),i=$(this),t(i),l.addClass("dragging"),h=!0,a=e.clientX-$(this).offset().left,o=e.clientY-$(this).offset().top,l.css("left",e.clientX-a+"px"),l.css("top",e.clientY-o+"px"))}),$(document).on("mouseup",function(e){if(1===e.which&&(h||x))if(i(),$(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"),h&&(n.removeClass("dragnow"),l.removeClass("dragging")),0==parseInt(l.children(".blockid").val())&&x){l.removeClass("dragging"),x=!1;for(var t=0;t<p.length;t++)p[t].id!=parseInt(l.children(".blockid").val())&&($(".blockid[value="+p[t].id+"]").parent().css("left",$(".blockid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".blockid[value="+p[t].id+"]").parent().css("top",$(".blockid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".arrowid[value="+p[t].id+"]").parent().css("left",$(".arrowid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".arrowid[value="+p[t].id+"]").parent().css("top",$(".arrowid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()+"px"),$(".blockid[value="+p[t].id+"]").parent().appendTo(c),$(".arrowid[value="+p[t].id+"]").parent().appendTo(c),p[t].x=$(".blockid[value="+p[t].id+"]").parent().offset().left+$(".blockid[value="+p[t].id+"]").innerWidth()/2+c.scrollLeft(),p[t].y=$(".blockid[value="+p[t].id+"]").parent().offset().top+$(".blockid[value="+p[t].id+"]").parent().innerHeight()/2+c.scrollTop());p.filter(e=>0==e.id)[0].x=l.offset().left+l.innerWidth()/2,p.filter(e=>0==e.id)[0].y=l.offset().top+l.innerHeight()/2,s=$.merge(s,p),p=[]}else if(h&&0==s.length&&l.offset().top>c.offset().top&&l.offset().left>c.offset().left)f(l),h=!1,l.css("top",l.offset().top-c.offset().top+c.scrollTop()+"px"),l.css("left",l.offset().left-c.offset().left+c.scrollLeft()+"px"),l.appendTo(c),s.push({parent:-1,childwidth:0,id:parseInt(l.children(".blockid").val()),x:l.offset().left+l.innerWidth()/2+c.scrollLeft(),y:l.offset().top+l.innerHeight()/2+c.scrollTop(),width:l.innerWidth(),height:l.innerHeight()});else if(h&&0==s.length)l.remove();else if(h||x)for(var r=l.offset().left+l.innerWidth()/2+c.scrollLeft(),d=l.offset().top+c.scrollTop(),a=s.map(e=>e.id),o=0;o<s.length;o++){if(r>=s.filter(e=>e.id==a[o])[0].x-s.filter(e=>e.id==a[o])[0].width/2-v&&r<=s.filter(e=>e.id==a[o])[0].x+s.filter(e=>e.id==a[o])[0].width/2+v&&d>=s.filter(e=>e.id==a[o])[0].y-s.filter(e=>e.id==a[o])[0].height/2&&d<=s.filter(e=>e.id==a[o])[0].y+s.filter(e=>e.id==a[o])[0].height){h=!1,x||(f(l),l.appendTo(c));var w=0,g=0;for(t=0;t<s.filter(e=>e.parent==a[o]).length;t++){(I=s.filter(e=>e.parent==a[o])[t]).childwidth>I.width?w+=I.childwidth+v:w+=I.width+v}w+=l.innerWidth();for(t=0;t<s.filter(e=>e.parent==a[o]).length;t++){(I=s.filter(e=>e.parent==a[o])[t]).childwidth>I.width?($(".blockid[value="+I.id+"]").parent().css("left",s.filter(e=>e.id==a[o])[0].x-w/2+g+I.childwidth/2-I.width/2+"px"),I.x=s.filter(e=>e.parent==a[o])[0].x-w/2+g+I.childwidth/2,g+=I.childwidth+v):($(".blockid[value="+I.id+"]").parent().css("left",s.filter(e=>e.id==a[o])[0].x-w/2+g+"px"),I.x=s.filter(e=>e.parent==a[o])[0].x-w/2+g+I.width/2,g+=I.width+v)}if(l.css("left",s.filter(e=>e.id==a[o])[0].x-w/2+g-c.offset().left+c.scrollLeft()+"px"),l.css("top",s.filter(e=>e.id==a[o])[0].y+s.filter(e=>e.id==a[o])[0].height/2+u-c.offset().top+"px"),x){p.filter(e=>e.id==parseInt(l.children(".blockid").val()))[0].x=l.offset().left+l.innerWidth()/2+c.scrollLeft()+c.scrollLeft(),p.filter(e=>e.id==parseInt(l.children(".blockid").val()))[0].y=l.offset().top+l.innerHeight()/2+c.scrollTop(),p.filter(e=>e.id==l.children(".blockid").val())[0].parent=a[o];for(t=0;t<p.length;t++)p[t].id!=parseInt(l.children(".blockid").val())&&($(".blockid[value="+p[t].id+"]").parent().css("left",$(".blockid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".blockid[value="+p[t].id+"]").parent().css("top",$(".blockid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".arrowid[value="+p[t].id+"]").parent().css("left",$(".arrowid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()+20),$(".arrowid[value="+p[t].id+"]").parent().css("top",$(".arrowid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".blockid[value="+p[t].id+"]").parent().appendTo(c),$(".arrowid[value="+p[t].id+"]").parent().appendTo(c),p[t].x=$(".blockid[value="+p[t].id+"]").parent().offset().left+$(".blockid[value="+p[t].id+"]").innerWidth()/2+c.scrollLeft(),p[t].y=$(".blockid[value="+p[t].id+"]").parent().offset().top+$(".blockid[value="+p[t].id+"]").parent().innerHeight()/2+c.scrollTop());s=$.merge(s,p),p=[]}else s.push({childwidth:0,parent:a[o],id:parseInt(l.children(".blockid").val()),x:l.offset().left+l.innerWidth()/2+c.scrollLeft(),y:l.offset().top+l.innerHeight()/2+c.scrollTop(),width:l.innerWidth(),height:l.innerHeight()});var b=s.filter(e=>e.id==parseInt(l.children(".blockid").val()))[0],C=b.x-s.filter(e=>e.id==a[o])[0].x+20,y=b.y-b.height/2-(s.filter(e=>e.parent==a[o])[0].y+s.filter(e=>e.parent==a[o])[0].height/2)+c.scrollTop();if(C<0?(l.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+l.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(s.filter(e=>e.id==a[o])[0].x-b.x+5)+" 0L"+(s.filter(e=>e.id==a[o])[0].x-b.x+5)+" "+u/2+"L5 "+u/2+"L5 "+y+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(y-5)+"H10L5 "+y+"L0 "+(y-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+l.children(".blockid").val()+"]").parent().css("left",b.x-5-c.offset().left+c.scrollLeft()+"px")):(l.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+l.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+u/2+"L"+C+" "+u/2+"L"+C+" "+y+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(C-5)+" "+(y-5)+"H"+(C+5)+"L"+C+" "+y+"L"+(C-5)+" "+(y-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+parseInt(l.children(".blockid").val())+"]").parent().css("left",s.filter(e=>e.id==a[o])[0].x-20-c.offset().left+c.scrollLeft()+"px")),$(".arrowid[value="+parseInt(l.children(".blockid").val())+"]").parent().css("top",s.filter(e=>e.id==a[o])[0].y+s.filter(e=>e.id==a[o])[0].height/2+"px"),-1!=s.filter(e=>e.id==a[o])[0].parent){for(var L=!1,T=a[o];!L;)if(-1==s.filter(e=>e.id==T)[0].parent)L=!0;else{var H=0;for(t=0;t<s.filter(e=>e.parent==T).length;t++){var I;(I=s.filter(e=>e.parent==T)[t]).childwidth>I.width?t==s.filter(e=>e.parent==T).length-1?H+=I.childwidth:H+=I.childwidth+v:t==s.filter(e=>e.parent==T).length-1?H+=I.width:H+=I.width+v}s.filter(e=>e.id==T)[0].childwidth=H,T=s.filter(e=>e.id==T)[0].parent}s.filter(e=>e.id==T)[0].childwidth=w}x&&(x=!1,l.removeClass("dragging")),m(),k();break}o==s.length-1&&(x&&(x=!1,p=[]),h=!1,l.remove())}}),$(document).on("mousedown",".block",function(e){$(document).on("mouseup mousemove",".block",function e(t){if("mouseup"!==t.type&&1===t.which&&!h&&!x){x=!0,(l=$(this)).addClass("dragging"),a=t.clientX-$(this).offset().left,o=t.clientY-$(this).offset().top;var i=parseInt($(this).children(".blockid").val());l=$(this),p.push(s.filter(e=>e.id==i)[0]),s=$.grep(s,function(e){return e.id!=i}),$(".arrowid[value="+i+"]").parent().remove();for(var r=s.filter(e=>e.parent==i),d=!1,f=[],n=[];!d;){for(var v=0;v<r.length;v++)p.push(s.filter(e=>e.id==r[v].id)[0]),$(".blockid[value="+r[v].id+"]").parent().css("left",$(".blockid[value="+r[v].id+"]").parent().offset().left-l.offset().left),$(".blockid[value="+r[v].id+"]").parent().css("top",$(".blockid[value="+r[v].id+"]").parent().offset().top-l.offset().top),$(".arrowid[value="+r[v].id+"]").parent().css("left",$(".arrowid[value="+r[v].id+"]").parent().offset().left-l.offset().left),$(".arrowid[value="+r[v].id+"]").parent().css("top",$(".arrowid[value="+r[v].id+"]").parent().offset().top-l.offset().top),$(".blockid[value="+r[v].id+"]").parent().appendTo(l),$(".arrowid[value="+r[v].id+"]").parent().appendTo(l),f.push(r[v].id),n.push(r[v].id);0==f.length?d=!0:(r=s.filter(e=>f.includes(e.parent)),f=[])}for(v=0;v<s.filter(e=>e.parent==i).length;v++){var u=s.filter(e=>e.parent==i)[v];s=$.grep(s,function(e){return e.id!=u})}for(v=0;v<n.length;v++){u=n[v];s=$.grep(s,function(e){return e.id!=u})}s.length>1&&m(),b&&function(){if(g<c.offset().left){b=!1;for(var e=s.map(e=>e.id),t=0;t<s.length;t++)if($(".blockid[value="+s.filter(i=>i.id==e[t])[0].id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-s.filter(i=>i.id==e[t])[0].width/2-g-20),s.filter(i=>i.id==e[t])[0].x=$(".blockid[value="+s.filter(i=>i.id==e[t])[0].id+"]").parent().offset().left+s.filter(i=>i.id==e[t])[0].width/2,-1!=s.filter(i=>i.id==e[t])[0].parent){var i=s.filter(i=>i.id==e[t])[0],l=i.x-s.filter(i=>i.id==s.filter(i=>i.id==e[t])[0].parent)[0].x;l<0?$(".arrowid[value="+e[t]+"]").parent().css("left",i.x-5-c.offset().left+"px"):$(".arrowid[value="+e[t]+"]").parent().css("left",s.filter(i=>i.id==s.filter(i=>i.id==e[t])[0].parent)[0].x-20-c.offset().left+"px")}for(var t=0;t<s.length;t++);g=0}}()}$(document).off("mouseup mousemove",e)})}),$(document).on("mousemove",function(e){if(h?(l.css("left",e.clientX-a+"px"),l.css("top",e.clientY-o+"px")):x&&(l.css("left",e.clientX-a-c.offset().left+c.scrollLeft()+"px"),l.css("top",e.clientY-o-c.offset().top+c.scrollTop()+"px"),p.filter(e=>e.id==parseInt(l.children(".blockid").val())).x=l.offset().left+l.innerWidth()/2+c.scrollLeft(),p.filter(e=>e.id==parseInt(l.children(".blockid").val())).y=l.offset().left+l.innerHeight()/2+c.scrollTop()),h||x)for(var t=l.offset().left+l.innerWidth()/2+c.scrollLeft(),i=l.offset().top+c.scrollTop(),r=s.map(e=>e.id),d=0;d<s.length;d++){if(t>=s.filter(e=>e.id==r[d])[0].x-s.filter(e=>e.id==r[d])[0].width/2-v&&t<=s.filter(e=>e.id==r[d])[0].x+s.filter(e=>e.id==r[d])[0].width/2+v&&i>=s.filter(e=>e.id==r[d])[0].y-s.filter(e=>e.id==r[d])[0].height/2&&i<=s.filter(e=>e.id==r[d])[0].y+s.filter(e=>e.id==r[d])[0].height){$(".indicator").appendTo($(".blockid[value="+r[d]+"]").parent()),$(".indicator").css("left",$(".blockid[value="+r[d]+"]").parent().innerWidth()/2-5+"px"),$(".indicator").css("top",$(".blockid[value="+r[d]+"]").parent().innerHeight()+"px"),$(".indicator").removeClass("invisible");break}d==s.length-1&&($(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"))}})})};